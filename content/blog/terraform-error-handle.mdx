---
title: 'í…Œë¼í¼ ì—ëŸ¬ í•¸ë“¤ë§'
date: '2025-07-19'
category: 'INFRA'
summary: 'í…Œë¼í¼ ì—ëŸ¬ í•¸ë“¤ë§ì„ í•˜ë©´ì„œ ë°°ì› ë˜ ì ì„ ê¸°ë¡í–ˆì–´ìš”.'
---


## ğŸš¨ ë¬¸ì œ ìƒí™©

Terraformìœ¼ë¡œ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ë˜ ì¤‘ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ë“¤ì´ ì—°ì†ìœ¼ë¡œ ë°œìƒí–ˆì–´ìš”:

```bash
Error: creating EC2 EIP: operation error EC2: AllocateAddress,
https response error StatusCode: 400, RequestID: <requiest id>,
api error AddressLimitExceeded: The maximum number of addresses has been reached.

Error: creating KMS Alias (alias/eks/cwave): operation error KMS: CreateAlias,
https response error StatusCode: 400, RequestID: <requiest id>,
AlreadyExistsException: An alias with the name arn:aws:kms:ap-northeast-2:368677659737:alias/eks/cwave already exists

Error: creating EKS Cluster (cwave): operation error EKS: CreateCluster,
https response error StatusCode: 409, RequestID: <requiest id>,
ResourceInUseException: Cluster already exists with name: cwave

Error: creating IAM Role (efs-csi): operation error IAM: CreateRole,
https response error StatusCode: 409, RequestID: <requiest id>,
EntityAlreadyExists: Role with name efs-csi already exists.
```

## ğŸ” ë¬¸ì œ ì›ì¸ ë¶„ì„

### ê·¼ë³¸ ì›ì¸: ê°œë°œ í™˜ê²½ í˜¼ë™ìœ¼ë¡œ ì¸í•œ ë¦¬ì†ŒìŠ¤ ì¤‘ë³µ

**ì‹¤ì œ ë°œìƒ ê³¼ì •:**

1. ê°œë°œ í™˜ê²½ì— `local`ê³¼ `aws` ë‘ ê°œì˜ í´ë”ê°€ ì¡´ì¬
2. ì§€ê¸ˆê¹Œì§€ local í™˜ê²½ê³¼ aws í™˜ê²½ì„ ì°©ê°í•´ì„œ ê°œë°œì„ ì§„í–‰
3. local í™˜ê²½ì—ì„œ ìƒì„±í•œ Terraform ë¦¬ì†ŒìŠ¤ë¥¼ ì •í™•í•˜ê²Œ ì‚­ì œí•˜ì§€ ì•ŠìŒ
4. aws í´ë”ë¡œ ì´ë™í•´ì„œ ë‹¤ì‹œ `terraform apply`ë¥¼ ì‹œë„
5. **ê²°ê³¼**: ë™ì¼í•œ ë¦¬ì†ŒìŠ¤ëª…ìœ¼ë¡œ ì¸í•œ ì¤‘ë³µ ìƒì„± ì‹œë„ë¡œ ì¶©ëŒ ë°œìƒí–ˆì–´ìš”

**í´ë” êµ¬ì¡° ì˜ˆì‹œ:**

```
project/
â”œâ”€â”€ local/          # ë¡œì»¬ ê°œë°œìš© (ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì”ì¡´)
â”‚   â”œâ”€â”€ main.tf
â”‚   â””â”€â”€ terraform.tfstate
â””â”€â”€ aws/            # AWS í™˜ê²½ìš© (ìƒˆë¡œ ë°°í¬ ì‹œë„)
    â”œâ”€â”€ main.tf
    â””â”€â”€ terraform.tfstate
```

### ì„¸ë¶€ ì›ì¸ë“¤

#### 1. EIP í•œë„ ì´ˆê³¼ ë¬¸ì œ

AWS ê³„ì •ë‹¹ EIP(Elastic IP) í• ë‹¹ í•œë„ê°€ ìˆê³  ì œê°€ í™•ì¸í–ˆì„ ë•ŒëŠ” 5ê°œê°€ í• ë‹¹ í•œë„ê°€ ìˆì—ˆì–´ìš”.

```bash
# í˜„ì¬ EIP ì‚¬ìš©ëŸ‰ í™•ì¸
aws ec2 describe-addresses --region ap-northeast-2
```

#### 2. ë¦¬ì†ŒìŠ¤ ì¤‘ë³µ ë¬¸ì œ

EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí–ˆì§€ë§Œ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë“¤(IAM ì—­í• , KMS ë³„ì¹­ ë“±)ì€ ìë™ìœ¼ë¡œ ì‚­ì œë˜ì§€ ì•Šì•˜ì–´ìš”.

**ì™œ ì´ëŸ° ì¼ì´ ë°œìƒí•˜ëŠ”ê°€?**

- EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ ì‹œ **IAM ì—­í• ì€ ìë™ìœ¼ë¡œ ì‚­ì œë˜ì§€ ì•Šì•„ìš”.**
- KMS ë³„ì¹­ë„ ë§ˆì°¬ê°€ì§€ë¡œ ìˆ˜ë™ ì‚­ì œê°€ í•„ìš”í•´ìš”.

#### 3. Terraform ìƒíƒœ íŒŒì¼ ë¶„ë¦¬ë¡œ ì¸í•œ ë¬¸ì œ

- `local/terraform.tfstate`ì™€ `aws/terraform.tfstate`ê°€ ê°ê° ê´€ë¦¬ë¼ìš”.
- ì‹¤ì œ AWS ë¦¬ì†ŒìŠ¤ëŠ” ë™ì¼í•˜ì§€ë§Œ Terraform ìƒíƒœëŠ” ë¶„ë¦¬ë˜ì–´ ìˆì–´ìš”.
- ìƒˆë¡œìš´ í´ë”ì—ì„œ ë°°í¬ ì‹œ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ë¥¼ ì¸ì‹í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ìˆëŠ” ê²ƒì„ íŒŒì•…í–ˆì–´ìš”.

## ğŸ› ï¸ í•´ê²° ê³¼ì •

### 1ë‹¨ê³„: EIP ì‚¬ìš©ëŸ‰ í™•ì¸ ë° ë¶„ì„

```bash
# EIP ëª©ë¡ê³¼ ì—°ê²° ìƒíƒœ í™•ì¸
aws ec2 describe-addresses --region ap-northeast-2 --output table

# ê° EIPê°€ ë¬´ì—‡ì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
aws ec2 describe-network-interfaces --region ap-northeast-2 \
  --network-interface-ids eni-xxxx eni-yyyy \
  --query 'NetworkInterfaces[*].{NetworkInterfaceId:NetworkInterfaceId,Description:Description,Status:Status}'
```

**ê²°ê³¼ ë¶„ì„:**

```json
[
  {
    "NetworkInterfaceId": "eni-id",
    "Description": "Interface for NAT Gateway nat-id",
    "Status": "in-use"
  }
  // ... 5ê°œì˜ EIPê°€ ëª¨ë‘ NAT Gatewayì— ì—°ê²°ë¨
]
```

### 2ë‹¨ê³„: Terraform ìƒíƒœ í™•ì¸

```bash
# í˜„ì¬ Terraformì—ì„œ ê´€ë¦¬í•˜ëŠ” EIP í™•ì¸
terraform plan | grep eip
```

**ê²°ê³¼:**

```
aws_eip.nat["c"]: Refreshing state... [id=eipalloc-id]
aws_eip.nat["a"]: Refreshing state... [id=eipalloc-id]
# aws_eip.nat["b"] will be created <- ì´ ë¶€ë¶„ì´ ë¬¸ì œ!
```

**ë°œê²¬í•œ ë¬¸ì œì :**

- `nat["a"]`ì™€ `nat["c"]`ëŠ” ì´ë¯¸ Terraform ìƒíƒœì— ì¡´ì¬í•´ìš”.
- `nat["b"]`ë§Œ ìƒˆë¡œ ìƒì„±í•˜ë ¤ê³  í•´ì„œ EIP í•œë„ ì´ˆê³¼ ë°œìƒê°€ ë°œìƒí–ˆì–´ìš”.

### 3ë‹¨ê³„: EIP ë¬¸ì œ í•´ê²°

**ë°©ë²• 1: ê¸°ì¡´ EIP ì¬ì‚¬ìš©**

```bash
# ì‚¬ìš© ê°€ëŠ¥í•œ EIP í™•ì¸ (a, cê°€ ì•„ë‹Œ ê²ƒë“¤)
# eipalloc-id
# eipalloc-id
# eipalloc-id

# íŠ¹ì • EIPê°€ ì–´ë–¤ NAT Gatewayì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
aws ec2 describe-nat-gateways --region ap-northeast-2 \
  --query 'NatGateways[?NatGatewayAddresses[0].AllocationId==`eipalloc-id`].{NatGatewayId:NatGatewayId,State:State}'
```

**ê²°ê³¼:**

```json
[
  {
    "NatGatewayId": "nat-id",
    "State": "deleted" // ì´ë¯¸ ì‚­ì œë¨
  },
  {
    "NatGatewayId": "nat-id",
    "State": "available" // ì‚¬ìš© ì¤‘
  }
]
```

**í•´ê²° ë‹¨ê³„:**

```bash
# 1. ì‚¬ìš© ì¤‘ì¸ NAT Gateway ì‚­ì œ
aws ec2 delete-nat-gateway --nat-gateway-id nat-id --region ap-northeast-2

# 2. ì‚­ì œ ì™„ë£Œ ëŒ€ê¸°
aws ec2 describe-nat-gateways --region ap-northeast-2 --nat-gateway-ids nat-id --query 'NatGateways[0].State'

# 3. í•´ì œëœ EIPë¥¼ Terraformìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
terraform import 'aws_eip.nat["b"]' eipalloc-id
```

### 4ë‹¨ê³„: ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ Import

```bash
# EKS í´ëŸ¬ìŠ¤í„° ê°€ì ¸ì˜¤ê¸°
terraform import module.eks.aws_eks_cluster.this[0] cwave

# KMS ë³„ì¹­ ê°€ì ¸ì˜¤ê¸° (ë”°ì˜´í‘œ ì£¼ì˜!)
terraform import 'module.eks.module.kms.aws_kms_alias.this["cluster"]' alias/eks/cwave

# IAM ì—­í• ë“¤ ê°€ì ¸ì˜¤ê¸°
terraform import module.attach_efs_csi_role.aws_iam_role.this[0] efs-csi
terraform import module.ebs_csi_irsa.aws_iam_role.this[0] cwave-ebs-csi-controller
terraform import module.lb_controller_role.aws_iam_role.this[0] eks-aws-lb-controller-role
```

**Import ì‹œ ì£¼ì˜ì‚¬í•­:**

- ì¸ë±ìŠ¤ê°€ ìˆëŠ” ë¦¬ì†ŒìŠ¤ëŠ” ë”°ì˜´í‘œë¡œ ê°ì‹¸ì£¼ëŠ” ê²ƒì´ ì¤‘ìš”í•´ìš”.
- ì •í™•í•œ ë¦¬ì†ŒìŠ¤ ì´ë¦„ê³¼ ID í™•ì¸ í•„ìˆ˜ì…ë‹ˆë‹¤.

### 5ë‹¨ê³„: Terraform ì ìš©

```bash
# ê³„íš í™•ì¸
terraform plan

# ë¬¸ì œì—†ìœ¼ë©´ ì ìš©
terraform apply
```

## ğŸ”§ kubectl ì—°ê²° ë¬¸ì œ í•´ê²°

ë°°í¬ ì™„ë£Œ í›„ kubectl ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ DNS ì˜¤ë¥˜ ë°œìƒ:

```bash
kubectl get po
# Error: dial tcp: lookup .gr7.ap-northeast-2.eks.amazonaws.com on 127.0.0.11:53: no such host
```

**í•´ê²° ë°©ë²•:**

ì—…ë°ì´í„°ë¥¼ ìƒˆë¡œ í•´ì¤Œìœ¼ë¡œì¨ ê¸°ì¡´ contextë¥¼ switchë¥¼ ì§„í–‰í•´ì£¼ë©´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.

```bash
# kubeconfig ì—…ë°ì´íŠ¸
aws eks update-kubeconfig --region ap-northeast-2 --name cwave

# ì—°ê²° í…ŒìŠ¤íŠ¸
kubectl get nodes
kubectl get pods -A
```

## ğŸ“ êµí›ˆ ë° ì˜ˆë°© ë°©ë²•

### 1. ê°œë°œ í™˜ê²½ ê´€ë¦¬ ì›ì¹™

- **í™˜ê²½ë³„ í´ë” ë¶„ë¦¬ ì‹œ ëª…í™•í•œ ë„¤ì´ë° ì‚¬ìš©**
- **í˜„ì¬ ì‘ì—… ì¤‘ì¸ í™˜ê²½ì„ í•­ìƒ í™•ì¸**
- **í™˜ê²½ ì „í™˜ ì‹œ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ í›„ ì§„í–‰**

```bash
# í™˜ê²½ í™•ì¸ ìŠµê´€í™”
pwd                    # í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬ í™•ì¸
terraform workspace show  # Terraform ì›Œí¬ìŠ¤í˜ì´ìŠ¤ í™•ì¸
aws sts get-caller-identity  # í˜„ì¬ AWS ê³„ì •/ì—­í•  í™•ì¸
```

### 2. ì•ˆì „í•œ í™˜ê²½ ì „í™˜ ì ˆì°¨

```bash
# ê¸°ì¡´ í™˜ê²½ ì •ë¦¬
terraform destroy -auto-approve

# ìƒíƒœ íŒŒì¼ ë°±ì—…
cp terraform.tfstate terraform.tfstate.backup

# ìƒˆ í™˜ê²½ìœ¼ë¡œ ì´ë™
cd ../aws

# ë¦¬ì†ŒìŠ¤ í™•ì¸ í›„ ë°°í¬
terraform plan
terraform apply
```

### 3. ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹œ ì£¼ì˜ì 

- EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ ì‹œ IAM ì—­í• , KMS ë³„ì¹­ ë“±ì€ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì–´ì•¼ í•´ìš”.
- ë§Œì•½ ì‚­ì œí•´ì£¼ì–´ì•¼ í•˜ëŠ”ê²Œ ë§ë‹¤ë©´ Terraform importë¥¼ í™œìš©í•˜ì—¬ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.

### 4. EIP ê´€ë¦¬

- AWS ê³„ì •ì˜ EIP í•œë„ë¥¼ ë¯¸ë¦¬ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´ìš”.
- ë¶ˆí•„ìš”í•œ EIPëŠ” ì •ê¸°ì ìœ¼ë¡œ ì •ë¦¬í•˜ê³  í•„ìš”ì‹œ AWS Supportë¥¼ í†µí•´ í•œë„ ì¦ê°€ ìš”ì²­í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.

### 5. Terraform ìƒíƒœ ê´€ë¦¬

- `terraform plan`ìœ¼ë¡œ ìƒì„±ë  ë¦¬ì†ŒìŠ¤ë¥¼ ë¯¸ë¦¬ í™•ì¸í•˜ëŠ” ìŠµê´€ì´ ì •ë§ ì¤‘ìš”í•©ë‹ˆë‹¤.
- ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ì™€ì˜ ì¶©ëŒ ê°€ëŠ¥ì„± ê²€í†  ë° Importë¥¼ í™œìš©í•œ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì¬ì‚¬ìš©ì„ ê³ ë ¤í•  ìˆ˜ ìˆì–´ìš”.

### 6. ì•ˆì „í•œ ë°°í¬ ì „ëµ

```bash
# ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
terraform plan                    # ìƒì„±ë  ë¦¬ì†ŒìŠ¤ í™•ì¸
aws ec2 describe-addresses        # EIP ì‚¬ìš©ëŸ‰ í™•ì¸
aws iam list-roles               # ê¸°ì¡´ IAM ì—­í•  í™•ì¸
aws kms list-aliases             # ê¸°ì¡´ KMS ë³„ì¹­ í™•ì¸
```

## ğŸ¯ ê²°ë¡ 

ì´ë²ˆ ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì€ **ê°œë°œ í™˜ê²½ í˜¼ë™ìœ¼ë¡œ ì¸í•œ ë¦¬ì†ŒìŠ¤ ì¤‘ë³µ**ì´ì—ˆìŠµë‹ˆë‹¤. localê³¼ aws í™˜ê²½ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì§€ ì•Šê³  ê°œë°œí•˜ë‹¤ê°€, ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ìƒˆë¡œìš´ í™˜ê²½ì— ë°°í¬ë¥¼ ì‹œë„í•œ ê²ƒì´ ë¬¸ì œì˜ ì‹œì‘ì´ì—ˆìŠµë‹ˆë‹¤.

Terraformìœ¼ë¡œ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•  ë•ŒëŠ” ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ë°˜ë“œì‹œ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤:

1. **í™˜ê²½ ë¶„ë¦¬ì™€ ëª…í™•í•œ ì‹ë³„**
2. **ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ì™€ì˜ ì¶©ëŒ ê°€ëŠ¥ì„±**
3. **Terraform Importë¥¼ í™œìš©í•œ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì¬ì‚¬ìš©**

íŠ¹íˆ EKSì™€ ê°™ì€ ë³µì¡í•œ ì„œë¹„ìŠ¤ëŠ” ì—¬ëŸ¬ AWS ì„œë¹„ìŠ¤ì™€ ì—°ë™ë˜ì–´ ìˆì–´, ì‚­ì œ ì‹œì—ë„ ì¼ë¶€ ë¦¬ì†ŒìŠ¤ê°€ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ìƒí™©ì—ì„œëŠ” **Terraform Import**ë¥¼ í™œìš©í•˜ì—¬ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ í•´ê²°ì±…ì…ë‹ˆë‹¤.

---

**ê´€ë ¨ ëª…ë ¹ì–´ ëª¨ìŒ:**

```bash
# í™˜ê²½ í™•ì¸
pwd
terraform workspace show
aws sts get-caller-identity

# EIP ê´€ë ¨
aws ec2 describe-addresses --region ap-northeast-2
aws ec2 release-address --allocation-id eipalloc-xxx --region ap-northeast-2

# Terraform Import
terraform import 'resource_address' resource_id
terraform state list
terraform plan

# EKS ê´€ë ¨
aws eks update-kubeconfig --region ap-northeast-2 --name cluster-name
kubectl config current-context
```